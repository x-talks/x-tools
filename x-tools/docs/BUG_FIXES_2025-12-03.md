# Bug Fixes Summary

## Issue 1: Person Entries Not Deleted When Circle is Deleted

### Root Cause
The `person` table had `role_id` as a nullable column. When person records were created with `role_id = NULL`, the cascade delete chain (`circle` → `role` → `person`) would not work because there was no foreign key relationship to follow.

### Solution
1. **Migration `20251203020000_fix_person_role_null.sql`**:
   - Deletes orphaned person records with `NULL role_id`
   - Alters `person.role_id` to be `NOT NULL`

2. **Updated Initial Schema**:
   - Modified `20251202000000_initial_schema.sql` to define `role_id` as `NOT NULL` from the start

### Cascade Chain
```
circle (DELETE) 
  ↓ ON DELETE CASCADE
role (DELETE)
  ↓ ON DELETE CASCADE  
person (DELETE) ✓
```

### Testing
To verify the fix:
1. Create a circle with roles and people
2. Delete the circle
3. Check that all associated roles and people are also deleted

---

## Issue 2: Wizard Loses Data When Navigating Back

### Root Cause
Wizard step components (e.g., `Step1_Purpose`, `Step2_Vision`) used `useState` to initialize local state from global wizard state **only on mount**. When navigating back to a step:
- The component remounts
- Local state is re-initialized from global state
- But if the user had typed something and navigated away, the global state might not have been updated yet (due to debouncing)
- Result: Data loss

### Solution
1. **Created `useSyncedState` Hook** (`src/hooks/useSyncedState.ts`):
   - Custom hook that syncs local state with global state
   - Automatically updates local state when global state changes
   - Prevents data loss during navigation

2. **Updated `Step1_Purpose`**:
   - Replaced `useState` with `useSyncedState` for `purpose` and `metadata`
   - Removed manual sync `useEffect` (now handled by the hook)

3. **Added Regression Test** (`Step1_Purpose.test.tsx`):
   - Tests that user input is preserved when navigating back and forth
   - Ensures the fix doesn't regress in future updates

### Code Example
```typescript
// Before (loses data)
const [purpose, setPurpose] = useState(state.team?.teamPurpose || '');

// After (preserves data)
const [purpose, setPurpose] = useSyncedState(state.team?.teamPurpose, '');
```

### Next Steps
Apply the same `useSyncedState` fix to other wizard steps:
- `Step2_Vision`
- `Step3_Mission`
- `Step4_Strategy`
- `Step4_Values`
- `Step5_Principles`
- `Step6_Behaviors`
- `Step7_Goals`
- `Step8_Roles`

---

## Files Changed

### New Files
- `supabase/migrations/20251203020000_fix_person_role_null.sql`
- `src/hooks/useSyncedState.ts`
- `src/components/wizard/Step1_Purpose.test.tsx`

### Modified Files
- `supabase/migrations/20251202000000_initial_schema.sql`
- `src/components/wizard/Step1_Purpose.tsx`

---

## Migration Applied
✅ Migration `20251203020000_fix_person_role_null.sql` successfully applied to remote database

## Testing
Run the test suite:
```bash
npm test
```

Run specific test:
```bash
npm test Step1_Purpose.test.tsx
```
